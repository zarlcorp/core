#!/bin/sh
set -e

# find modules with staged changes
modules=$(git diff --cached --name-only | sed -n 's|^\(pkg/[^/]*\)/.*|\1|p' | sort -u)

# root-only changes (go.work, .golangci.yml, etc) â€” check all modules
if [ -z "$modules" ] && git diff --cached --name-only | grep -q .; then
  modules=$(find pkg -maxdepth 1 -mindepth 1 -type d | sort)
fi

[ -z "$modules" ] && exit 0

for mod in $modules; do
  printf "=== %s ===\n" "$mod"
  (cd "$mod" && go build ./...)
  (cd "$mod" && go vet ./...)
  (cd "$mod" && go test -short -race ./...)
  if command -v golangci-lint >/dev/null 2>&1; then
    (cd "$mod" && golangci-lint run --path-prefix="$mod")
  fi
done
